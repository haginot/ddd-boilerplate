name: Claude Code - Auto Fix CI Failures

# CI/ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸã¨ãã«è‡ªå‹•çš„ã«Claude Codeã§ä¿®æ­£ã‚’è©¦ã¿ã‚‹
on:
  workflow_run:
    workflows:
      - "Claude Code - Cloud Testing"
      - "Docker CI"
      - "AI-Generated Code Quality"
      - "Task Validation"
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: read

jobs:
  auto-fix:
    # å¤±æ•—æ™‚ã®ã¿å®Ÿè¡Œã€ã‹ã¤PRãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿
    # ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢: claude-auto-fix-ã§å§‹ã¾ã‚‹ãƒ–ãƒ©ãƒ³ãƒã¯é™¤å¤–
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] != null &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout failed branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "claude-code[bot]"
          git config user.email "claude-code[bot]@users.noreply.github.com"

      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests[0];
            if (pr) {
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_head_ref', context.payload.workflow_run.head_branch);
            }
            return pr ? pr.number : null;

      - name: Get failed job logs
        id: failure-info
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã‚’å–å¾—
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner,
              repo,
              run_id: runId,
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            let failureSummary = `# CI Failure Summary\n\n`;
            failureSummary += `**Workflow:** ${context.payload.workflow_run.name}\n`;
            failureSummary += `**Run ID:** ${runId}\n`;
            failureSummary += `**Branch:** ${context.payload.workflow_run.head_branch}\n\n`;

            for (const job of failedJobs) {
              failureSummary += `## Failed Job: ${job.name}\n\n`;

              // ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’å–å¾—
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner,
                  repo,
                  job_id: job.id,
                });

                // ãƒ­ã‚°ã®æœ€å¾Œã®500è¡Œã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼éƒ¨åˆ†ï¼‰
                const logLines = logs.data.split('\n');
                const relevantLogs = logLines.slice(-500).join('\n');
                failureSummary += `\`\`\`\n${relevantLogs}\n\`\`\`\n\n`;
              } catch (e) {
                failureSummary += `(Could not fetch logs: ${e.message})\n\n`;
              }

              // å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’ç‰¹å®š
              const failedSteps = job.steps?.filter(step => step.conclusion === 'failure') || [];
              if (failedSteps.length > 0) {
                failureSummary += `### Failed Steps:\n`;
                for (const step of failedSteps) {
                  failureSummary += `- ${step.name}\n`;
                }
                failureSummary += `\n`;
              }
            }

            // å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆé•·ã„ãƒ­ã‚°å¯¾ç­–ï¼‰
            const fs = require('fs');
            fs.writeFileSync('failure-summary.md', failureSummary);

            core.setOutput('failed_workflow', context.payload.workflow_run.name);
            core.setOutput('run_id', runId);

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Auto-fix with Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®å¤±æ•—æƒ…å ±ã‚’åˆ†æã—ã€å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            ## å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
            ${{ steps.failure-info.outputs.failed_workflow }}

            ## å¤±æ•—ã®è©³ç´°
            å¤±æ•—ã‚µãƒãƒªãƒ¼ã¯ `failure-summary.md` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

            ## ä¿®æ­£æ‰‹é †

            1. ã¾ãš `failure-summary.md` ã‚’èª­ã‚“ã§å¤±æ•—ã®åŸå› ã‚’ç‰¹å®š
            2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†æã—ã€æ ¹æœ¬åŸå› ã‚’ç‰¹å®š
            3. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚“ã§å•é¡Œã®ç®‡æ‰€ã‚’ç¢ºèª
            4. ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£

            ## é‡è¦ãªæ³¨æ„äº‹é …

            - ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯DDDï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼‰ã¨Clean Architectureã«å¾“ã£ã¦ã„ã¾ã™
            - `CLAUDE.md` ã‚’èª­ã‚“ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            - ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®ä¾å­˜é–¢ä¿‚ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆã—ã¦ãã ã•ã„:
              - Domainå±¤ã¯å¤–éƒ¨ä¾å­˜ãªã—
              - Applicationå±¤ã¯Domainã®ã¿ä¾å­˜å¯
              - Infrastructureå±¤ã¯Domainã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
            - æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„
            - æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ã‚’å°å…¥ã—ãªã„ã§ãã ã•ã„

            ## ã‚ˆãã‚ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯¾å‡¦æ³•

            - **ESLintè¨­å®šãªã—**: `.eslintrc.js` ã¾ãŸã¯ `eslint.config.js` ã‚’ä½œæˆ
            - **TypeScriptå‹ã‚¨ãƒ©ãƒ¼**: å‹å®šç¾©ã‚’ä¿®æ­£
            - **ãƒ†ã‚¹ãƒˆå¤±æ•—**: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¾ãŸã¯å®Ÿè£…ã‚’ä¿®æ­£
            - **ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼**: `package.json` ã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª
            - **Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³**: `package.json` ã® `engines` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª

            ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
          allowed_tools: |
            Edit
            MultiEdit
            Write
            Read
            Glob
            Grep
            LS
            Bash(npm:*)
            Bash(npx:*)
            Bash(git add:*)
            Bash(git commit:*)
            Bash(git status:*)
            Bash(git diff:*)
          max_turns: 30
          timeout_minutes: 15

      - name: Push fixes if changes exist
        id: push-fixes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "fix: auto-fix CI failures from ${{ steps.failure-info.outputs.failed_workflow }}

            Workflow Run: ${{ steps.failure-info.outputs.run_id }}

            ğŸ¤– Generated with Claude Code" || true

            git push origin ${{ github.event.workflow_run.head_branch }}
            echo "changes_pushed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to push"
            echo "changes_pushed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.push-fixes.outputs.changes_pushed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-info.outputs.pr_number }};
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ğŸ¤– Claude Code Auto-Fix

            CIå¤±æ•—ã‚’æ¤œå‡ºã—ã€è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã—ãŸã€‚

            **å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:** ${{ steps.failure-info.outputs.failed_workflow }}
            **ä¿®æ­£ã‚³ãƒŸãƒƒãƒˆ:** ã“ã®PRã«è‡ªå‹•çš„ã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã—ãŸ

            å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡ŒãŒãªã„ã‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`
              });
            }

      - name: Comment if no fix applied
        if: steps.push-fixes.outputs.changes_pushed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-info.outputs.pr_number }};
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ğŸ¤– Claude Code Auto-Fix

            CIå¤±æ•—ã‚’æ¤œå‡ºã—ã¾ã—ãŸãŒã€è‡ªå‹•ä¿®æ­£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

            **å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:** ${{ steps.failure-info.outputs.failed_workflow }}
            **Run ID:** ${{ steps.failure-info.outputs.run_id }}

            æ‰‹å‹•ã§ã®ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)`
              });
            }
