name: Task Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

jobs:
  validate-task:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Extract Task ID from PR
        id: task-id
        run: |
          # Try to extract task ID from PR title [Task #N] or Task-N format
          TASK_ID=$(echo "${{ github.event.pull_request.title }}" | grep -oP '\[Task #?\K\d+' || echo "")
          if [ -z "$TASK_ID" ]; then
            TASK_ID=$(echo "${{ github.event.pull_request.title }}" | grep -oP 'Task-?\K\d+' || echo "")
          fi
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          if [ -n "$TASK_ID" ]; then
            echo "âœ… Found Task ID: $TASK_ID"
          else
            echo "âš ï¸ No Task ID found in PR title. Continuing without task validation."
          fi

      - name: Run Architecture Validation
        run: |
          echo "ðŸ—ï¸ Running architecture validation..."
          npm run validate:layers || npm run validate:architecture || echo "Architecture validation script not found, skipping..."

      - name: Run Type Check
        run: |
          echo "ðŸ“ Running TypeScript type check..."
          npm run typecheck

      - name: Run Tests
        run: |
          echo "ðŸ§ª Running tests..."
          npm test -- --passWithNoTests

      - name: Check Layer Dependencies
        run: |
          echo "ðŸ” Checking layer dependencies..."
          
          VIOLATIONS=0
          
          # Check domain layer for outer layer imports
          DOMAIN_FILES=$(find src -path "*/domain/*.ts" -type f 2>/dev/null || true)
          for file in $DOMAIN_FILES; do
            if grep -qE "from ['\"].*/(application|infrastructure|interface)/" "$file" 2>/dev/null; then
              echo "âŒ Domain layer violation in: $file"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Found $VIOLATIONS architecture violation(s)"
            exit 1
          else
            echo "âœ… No layer dependency violations found"
          fi

      - name: Comment on PR
        if: always() && steps.task-id.outputs.task_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const taskId = '${{ steps.task-id.outputs.task_id }}';
            const success = '${{ job.status }}' === 'success';
            
            const body = success 
              ? `âœ… **Task Validation Passed** for Task #${taskId}\n\n- Architecture validation: âœ“\n- Type check: âœ“\n- Tests: âœ“\n- Layer dependencies: âœ“`
              : `âŒ **Task Validation Failed** for Task #${taskId}\n\nPlease check the workflow logs for details.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  architecture-report:
    runs-on: ubuntu-latest
    needs: validate-task
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Architecture Report
        run: |
          echo "# Architecture Report" > architecture-report.md
          echo "" >> architecture-report.md
          echo "## Layer Structure" >> architecture-report.md
          echo "\`\`\`" >> architecture-report.md
          find src -type d -name "domain" -o -name "application" -o -name "infrastructure" -o -name "interface" 2>/dev/null | sort >> architecture-report.md || echo "No DDD layers found" >> architecture-report.md
          echo "\`\`\`" >> architecture-report.md
          
          cat architecture-report.md

      - name: Upload Architecture Report
        uses: actions/upload-artifact@v4
        with:
          name: architecture-report
          path: architecture-report.md
          retention-days: 7
